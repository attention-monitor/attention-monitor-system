<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADHD æ³¨æ„åŠ›ç›‘æµ‹ç³»ç»Ÿ v2.2</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f1923; color: #e0e0e0; overflow: hidden; height: 100vh; }

/* Layout â€” åŠ å®½ä¾§æ ä»¥å®¹çº³å…¬å¼å’Œè®¡ç®—è¿‡ç¨‹ */
.container { display: grid; grid-template-columns: 1fr 460px; height: 100vh; gap: 0; }
.video-area { position: relative; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.sidebar { background: #1a2332; padding: 14px; overflow-y: auto; border-left: 1px solid #2a3a4a; display: flex; flex-direction: column; gap: 10px; }
.sidebar::-webkit-scrollbar { width: 4px; }
.sidebar::-webkit-scrollbar-thumb { background: #3a4a5a; border-radius: 2px; }

/* Video */
video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
canvas#overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

/* Score Display */
.score-overlay { position: absolute; top: 20px; left: 20px; z-index: 10; }
.score-circle { width: 120px; height: 120px; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 4px solid; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
.score-number { font-size: 42px; font-weight: 700; line-height: 1; }
.score-label { font-size: 11px; opacity: 0.8; margin-top: 2px; }

/* Status overlay */
.status-overlay { position: absolute; top: 20px; right: 20px; z-index: 10; display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
.status-tag { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }

/* Start screen */
.start-screen { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(15,25,35,0.95); z-index: 20; transition: opacity 0.5s; }
.start-screen.hidden { opacity: 0; pointer-events: none; }
.start-screen h1 { font-size: 28px; color: #4a9eff; margin-bottom: 8px; }
.start-screen p { font-size: 14px; color: #8899aa; margin-bottom: 24px; }
.btn-start { padding: 14px 48px; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; background: #4a9eff; color: #fff; cursor: pointer; transition: all 0.2s; }
.btn-start:hover { background: #3a8eef; transform: scale(1.02); }
.btn-start:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

/* Sidebar sections */
.section { background: #1e2d3d; border-radius: 10px; padding: 12px; }
.section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #6a8a9a; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px; }
.section-title .icon { font-size: 13px; }

/* ===== å…¬å¼å±•ç¤ºåŒº ===== */
.formula-box { background: #0f1923; border-radius: 8px; padding: 10px 12px; margin-bottom: 8px; border-left: 3px solid #4a9eff; }
.formula-main { font-family: 'Courier New', monospace; font-size: 13px; color: #4a9eff; line-height: 1.6; }
.formula-sub { font-family: 'Courier New', monospace; font-size: 11px; color: #8899aa; line-height: 1.5; margin-top: 4px; }
.formula-note { font-size: 10px; color: #5a6a7a; margin-top: 6px; font-style: italic; }

/* ===== è®¡ç®—æ­¥éª¤ ===== */
.calc-steps { display: flex; flex-direction: column; gap: 4px; }
.calc-step { display: flex; align-items: center; gap: 8px; padding: 5px 8px; background: #0f1923; border-radius: 6px; font-size: 12px; font-family: 'Courier New', monospace; }
.calc-step-num { width: 18px; height: 18px; border-radius: 50%; background: #2a3a4a; color: #8899aa; font-size: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.calc-step-num.active { background: #4a9eff; color: #fff; }
.calc-step-label { color: #8899aa; flex-shrink: 0; }
.calc-step-expr { color: #e0e0e0; flex: 1; text-align: right; white-space: nowrap; overflow: hidden; }
.calc-step-result { font-weight: 700; color: #4a9eff; flex-shrink: 0; min-width: 36px; text-align: right; }
.calc-step.highlight { border: 1px solid #4a9eff44; }
.calc-step.final { border: 1px solid #36d39944; background: #36d39910; }
.calc-step.final .calc-step-result { color: #36d399; font-size: 14px; }
.calc-arrow { text-align: center; color: #3a4a5a; font-size: 10px; line-height: 1; }

/* ===== å…­ç»´è¯„åˆ†å¢å¼º ===== */
.dim-row { display: flex; align-items: center; gap: 6px; padding: 4px 0; font-size: 11px; }
.dim-icon { font-size: 14px; flex-shrink: 0; }
.dim-info { flex: 1; min-width: 0; }
.dim-header { display: flex; justify-content: space-between; align-items: center; }
.dim-name { color: #c0d0e0; font-weight: 500; }
.dim-weight { color: #5a6a7a; font-size: 10px; }
.dim-bar-track { height: 5px; background: #0f1923; border-radius: 3px; overflow: hidden; margin-top: 2px; }
.dim-bar-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
.dim-val { width: 42px; text-align: right; font-weight: 700; font-variant-numeric: tabular-nums; flex-shrink: 0; font-size: 12px; }
.dim-explain { font-size: 10px; color: #5a6a7a; margin-top: 1px; }

/* ===== é˜ˆå€¼æŒ‡ç¤ºå™¨ ===== */
.threshold-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
.threshold-item { background: #0f1923; border-radius: 6px; padding: 8px; display: flex; flex-direction: column; gap: 3px; }
.threshold-label { font-size: 10px; color: #6a8a9a; text-transform: uppercase; letter-spacing: 0.5px; }
.threshold-vals { display: flex; justify-content: space-between; align-items: center; }
.threshold-current { font-size: 13px; font-weight: 700; font-variant-numeric: tabular-nums; }
.threshold-ref { font-size: 10px; color: #5a6a7a; }
.threshold-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
.dot-pass { background: #36d399; box-shadow: 0 0 4px #36d39966; }
.dot-fail { background: #ff4a4a; box-shadow: 0 0 4px #ff4a4a66; }

/* ===== ADHD æ£€æµ‹é¢æ¿ ===== */
.adhd-panel { display: flex; flex-direction: column; gap: 6px; }
.adhd-pattern { display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: #0f1923; border-radius: 6px; border-left: 3px solid #3a4a5a; transition: border-color 0.3s; }
.adhd-pattern.triggered { border-left-color: #ff4a4a; }
.adhd-pattern-status { width: 8px; height: 8px; border-radius: 50%; background: #3a4a5a; flex-shrink: 0; transition: background 0.3s; }
.adhd-pattern.triggered .adhd-pattern-status { background: #ff4a4a; box-shadow: 0 0 6px #ff4a4a88; }
.adhd-pattern-info { flex: 1; }
.adhd-pattern-name { font-size: 12px; color: #c0d0e0; font-weight: 500; }
.adhd-pattern-desc { font-size: 10px; color: #5a6a7a; margin-top: 1px; }
.adhd-pattern-val { font-size: 11px; font-weight: 600; color: #5a6a7a; min-width: 30px; text-align: right; }
.adhd-pattern.triggered .adhd-pattern-val { color: #ff6a6a; }

/* ===== Metric rows ===== */
.metric { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; font-size: 12px; }
.metric-label { color: #8899aa; }
.metric-value { font-weight: 600; font-variant-numeric: tabular-nums; }

/* Chart */
.chart-canvas { width: 100%; height: 80px; border-radius: 6px; background: #0f1923; }

/* Controls */
.controls { display: flex; gap: 6px; flex-wrap: wrap; }
.btn-ctrl { padding: 6px 12px; font-size: 11px; border: 1px solid #3a4a5a; border-radius: 8px; background: transparent; color: #c0d0e0; cursor: pointer; transition: all 0.15s; }
.btn-ctrl:hover { background: #2a3a4a; }
.btn-ctrl.active { background: #4a9eff; border-color: #4a9eff; color: #fff; }
.btn-ctrl.danger { border-color: #ff4a4a; color: #ff6a6a; }
.btn-ctrl.danger:hover { background: #ff4a4a22; }
.btn-ctrl.export { border-color: #36d399; color: #36d399; }
.btn-ctrl.export:hover { background: #36d39922; }

/* Voice reminder indicator */
.voice-indicator { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 15; padding: 10px 24px; border-radius: 24px; background: rgba(255,100,50,0.9); color: #fff; font-size: 14px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
.voice-indicator.show { opacity: 1; }

/* ADHD alert overlay */
.adhd-alert-overlay { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 15; padding: 6px 16px; border-radius: 16px; background: rgba(255,180,0,0.85); color: #1a1a1a; font-size: 12px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; white-space: nowrap; }
.adhd-alert-overlay.show { opacity: 1; }

/* Loading */
.loading-bar { width: 200px; height: 4px; background: #2a3a4a; border-radius: 2px; margin-top: 16px; overflow: hidden; display: none; }
.loading-bar.active { display: block; }
.loading-bar-fill { width: 0%; height: 100%; background: #4a9eff; border-radius: 2px; transition: width 0.3s; }

/* Calibration overlay */
.calibration-overlay { position: absolute; inset: 0; z-index: 18; display: none; }
.calibration-overlay.active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
.calib-bg { position: absolute; inset: 0; background: rgba(15,25,35,0.6); }
.calib-dot { position: absolute; width: 20px; height: 20px; border-radius: 50%; background: #ff4a4a; box-shadow: 0 0 20px #ff4a4a88, 0 0 60px #ff4a4a44; transform: translate(-50%,-50%); animation: calib-pulse 1s ease-in-out infinite; z-index: 2; }
@keyframes calib-pulse { 0%,100%{transform:translate(-50%,-50%) scale(1);} 50%{transform:translate(-50%,-50%) scale(1.3);} }
.calib-ring { position: absolute; width: 48px; height: 48px; transform: translate(-50%,-50%); z-index: 1; }
.calib-ring circle { fill: none; stroke-width: 3; }
.calib-ring .ring-bg { stroke: #2a3a4a; }
.calib-ring .ring-fill { stroke: #4a9eff; stroke-linecap: round; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 0.1s; }
.calib-info { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 3; text-align: center; }
.calib-step-text { font-size: 16px; color: #fff; font-weight: 600; margin-bottom: 6px; }
.calib-progress-text { font-size: 12px; color: #8899aa; }
.calib-skip { margin-top: 12px; padding: 4px 16px; font-size: 11px; border: 1px solid #3a4a5a; border-radius: 16px; background: transparent; color: #8899aa; cursor: pointer; }
.calib-skip:hover { background: #2a3a4a; color: #c0d0e0; }

/* Baseline indicator */
.baseline-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
.baseline-badge.calibrated { background: #36d39922; color: #36d399; }
.baseline-badge.default { background: #f59e0b22; color: #f59e0b; }

/* Responsive */
@media (max-width: 900px) {
  .container { grid-template-columns: 1fr; grid-template-rows: 45vh 1fr; }
  .sidebar { border-left: none; border-top: 1px solid #2a3a4a; }
}
</style>
</head>
<body>

<div class="container">
  <div class="video-area">
    <video id="webcam" autoplay playsinline></video>
    <canvas id="overlay"></canvas>

    <div class="start-screen" id="startScreen">
      <h1>ADHD æ³¨æ„åŠ›ç›‘æµ‹ç³»ç»Ÿ</h1>
      <p>åŸºäº AI çš„å®æ—¶æ³¨æ„åŠ›ä¸è¡Œä¸ºåˆ†æ Â· é€‚ç”¨äºåœ¨çº¿è¯¾å ‚åœºæ™¯</p>
      <button class="btn-start" id="btnStart">å¯åŠ¨æ‘„åƒå¤´</button>
      <div class="loading-bar" id="loadingBar"><div class="loading-bar-fill" id="loadingBarFill"></div></div>
    </div>

    <div class="score-overlay" id="scoreOverlay" style="display:none;">
      <div class="score-circle" id="scoreCircle">
        <div class="score-number" id="scoreNumber">--</div>
        <div class="score-label">æ³¨æ„åŠ›åˆ†æ•°</div>
      </div>
    </div>

    <div class="status-overlay" id="statusOverlay" style="display:none;">
      <div class="status-tag" id="attentionTag">--</div>
      <div class="status-tag" id="fpsTag">-- FPS</div>
      <div class="status-tag" id="sessionTag" style="font-size:10px;">--:--:--</div>
    </div>

    <div class="voice-indicator" id="voiceIndicator">æ­£åœ¨æé†’...</div>
    <div class="adhd-alert-overlay" id="adhdAlertOverlay"></div>

    <!-- æ ¡å‡†è¦†ç›–å±‚ -->
    <div class="calibration-overlay" id="calibOverlay">
      <div class="calib-bg"></div>
      <div class="calib-dot" id="calibDot"></div>
      <svg class="calib-ring" id="calibRing" viewBox="0 0 48 48">
        <circle class="ring-bg" cx="24" cy="24" r="21"/>
        <circle class="ring-fill" id="calibRingFill" cx="24" cy="24" r="21" stroke-dasharray="132" stroke-dashoffset="132"/>
      </svg>
      <div class="calib-info">
        <div class="calib-step-text" id="calibStepText">è¯·æ³¨è§†çº¢ç‚¹</div>
        <div class="calib-progress-text" id="calibProgressText">å‡†å¤‡ä¸­...</div>
        <button class="calib-skip" onclick="AttentionMonitor.skipCalibration()">è·³è¿‡æ ¡å‡†</button>
      </div>
    </div>
  </div>

  <!-- ================================================================ -->
  <!-- ä¾§æ  â€” å±•ç¤ºå…¬å¼ã€è®¡ç®—è¿‡ç¨‹ã€æ ¸å¿ƒç®—æ³• -->
  <!-- ================================================================ -->
  <div class="sidebar">

    <!-- â‘  è®ºæ–‡å…¬å¼ 14 -->
    <div class="section">
      <div class="section-title"><span class="icon">f</span> è®ºæ–‡å…¬å¼ 14 â€” æ³¨æ„åŠ›è¯„åˆ†æ¨¡å‹</div>
      <div class="formula-box">
        <div class="formula-main">S<sub>att</sub>(t) = S<sub>base</sub> + Î´<sub>emotion</sub> + Î´<sub>ADHD</sub></div>
        <div class="formula-sub">S<sub>base</sub> = wâ‚Â·Eye + wâ‚‚Â·Gaze + wâ‚ƒÂ·Head + wâ‚„Â·Duration + wâ‚…Â·Blink + wâ‚†Â·Motor</div>
        <div class="formula-note">è®ºæ–‡åŸå¼ä¸ºå‡æ³• (100â†’0)ï¼Œä»£ç ç­‰ä»·å®ç°ä¸ºåŠ æ³• (0â†’100)ï¼Œæœ€ç»ˆç»éçº¿æ€§ç¼©æ”¾æ˜ å°„åˆ° [0,100]</div>
      </div>
    </div>

    <!-- â‘¡ å®æ—¶è®¡ç®—è¿‡ç¨‹ -->
    <div class="section">
      <div class="section-title"><span class="icon">âš™</span> å®æ—¶è®¡ç®—è¿‡ç¨‹</div>
      <div class="calc-steps" id="calcSteps">
        <div class="calc-step highlight">
          <span class="calc-step-num active">1</span>
          <span class="calc-step-label">S_base</span>
          <span class="calc-step-expr" id="cs-base-expr">= 0+0+0+0+0+0</span>
          <span class="calc-step-result" id="cs-base">=0</span>
        </div>
        <div class="calc-arrow">â†“</div>
        <div class="calc-step">
          <span class="calc-step-num active">2</span>
          <span class="calc-step-label">+æƒ…ç»ª</span>
          <span class="calc-step-expr" id="cs-emo-expr">Webç‰ˆæš‚æ— æƒ…ç»ªæ¨¡å‹</span>
          <span class="calc-step-result" id="cs-emo">+0</span>
        </div>
        <div class="calc-arrow">â†“</div>
        <div class="calc-step">
          <span class="calc-step-num active">3</span>
          <span class="calc-step-label">+ADHD</span>
          <span class="calc-step-expr" id="cs-adhd-expr">DSM-5 è¡Œä¸ºæ¨¡å¼æ£€æµ‹</span>
          <span class="calc-step-result" id="cs-adhd">+0</span>
        </div>
        <div class="calc-arrow">â†“</div>
        <div class="calc-step">
          <span class="calc-step-num active">4</span>
          <span class="calc-step-label">ç¼©æ”¾</span>
          <span class="calc-step-expr" id="cs-scale-expr">nonlinear(0)</span>
          <span class="calc-step-result" id="cs-scale">=0</span>
        </div>
        <div class="calc-arrow">â†“</div>
        <div class="calc-step final">
          <span class="calc-step-num active">5</span>
          <span class="calc-step-label">æœ€ç»ˆ</span>
          <span class="calc-step-expr">clamp [0, 100]</span>
          <span class="calc-step-result" id="cs-final">0</span>
        </div>
      </div>
    </div>

    <!-- â‘¢ å…­ç»´å­è¯„åˆ†è¯¦è§£ -->
    <div class="section">
      <div class="section-title"><span class="icon">â—‰</span> å…­ç»´å­è¯„åˆ† (æƒé‡æ€»å’Œ = 100)</div>

      <div class="dim-row">
        <span class="dim-icon">ğŸ‘</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">çœ¼ç›çå¼€åº¦</span><span class="dim-weight">wâ‚ æ»¡åˆ†25</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-eye" style="width:0%;background:#4a9eff"></div></div>
          <div class="dim-explain" id="exp-eye">EAR(çœ¼ç›çºµæ¨ªæ¯”) â‰¥ 0.22 â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-eye">0/25</span>
      </div>

      <div class="dim-row">
        <span class="dim-icon">ğŸ¯</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">è§†çº¿ç¨³å®šæ€§</span><span class="dim-weight">wâ‚‚ æ»¡åˆ†20</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-gaze" style="width:0%;background:#36d399"></div></div>
          <div class="dim-explain" id="exp-gaze">è™¹è†œåç§»é‡ â‰¤ 0.15 â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-gaze">0/20</span>
      </div>

      <div class="dim-row">
        <span class="dim-icon">ğŸ—£</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">å¤´éƒ¨ç¨³å®šæ€§</span><span class="dim-weight">wâ‚ƒ æ»¡åˆ†15</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-head" style="width:0%;background:#f59e0b"></div></div>
          <div class="dim-explain" id="exp-head">yaw+pitch åç§» â‰¤ 8Â° â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-head">0/15</span>
      </div>

      <div class="dim-row">
        <span class="dim-icon">â±</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">æŒç»­ä¸“æ³¨æ—¶é•¿</span><span class="dim-weight">wâ‚„ æ»¡åˆ†20</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-duration" style="width:0%;background:#a78bfa"></div></div>
          <div class="dim-explain" id="exp-duration">è¿ç»­ä¸“æ³¨ â‰¥ 10s â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-duration">0/20</span>
      </div>

      <div class="dim-row">
        <span class="dim-icon">ğŸ‘€</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">çœ¨çœ¼æ¨¡å¼</span><span class="dim-weight">wâ‚… æ»¡åˆ†10</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-blink" style="width:0%;background:#f472b6"></div></div>
          <div class="dim-explain" id="exp-blink">æ­£å¸¸é¢‘ç‡ 10~30æ¬¡/åˆ† â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-blink">0/10</span>
      </div>

      <div class="dim-row">
        <span class="dim-icon">ğŸ’º</span>
        <div class="dim-info">
          <div class="dim-header"><span class="dim-name">è¿åŠ¨èºåŠ¨åº¦</span><span class="dim-weight">wâ‚† æ»¡åˆ†10</span></div>
          <div class="dim-bar-track"><div class="dim-bar-fill" id="bar-motor" style="width:0%;background:#fb923c"></div></div>
          <div class="dim-explain" id="exp-motor">å¾®åŠ¨é¢‘ç‡ < 1.5æ¬¡/5s â†’ æ»¡åˆ†åŒº</div>
        </div>
        <span class="dim-val" id="val-motor">0/10</span>
      </div>
    </div>

    <!-- â‘£ æ ¸å¿ƒé˜ˆå€¼å®æ—¶å¯¹ç…§ -->
    <div class="section">
      <div class="section-title"><span class="icon">âŠ˜</span> æ ¸å¿ƒé˜ˆå€¼å®æ—¶å¯¹ç…§ (æ¥è‡ª AttentionConfig)</div>
      <div class="threshold-grid">
        <div class="threshold-item">
          <span class="threshold-label">EAR å·¦çœ¼</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-ear-l">0.000</span>
            <span class="threshold-dot dot-pass" id="dot-ear-l"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: > 0.21 = ççœ¼</span>
        </div>
        <div class="threshold-item">
          <span class="threshold-label">EAR å³çœ¼</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-ear-r">0.000</span>
            <span class="threshold-dot dot-pass" id="dot-ear-r"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: > 0.21 = ççœ¼</span>
        </div>
        <div class="threshold-item">
          <span class="threshold-label">Yaw å·¦å³è½¬å¤´</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-yaw">0.0Â°</span>
            <span class="threshold-dot dot-pass" id="dot-yaw"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: |yaw| < 20Â° = æ­£é¢</span>
        </div>
        <div class="threshold-item">
          <span class="threshold-label">Pitch ä¸Šä¸‹ç‚¹å¤´</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-pitch">0.0Â°</span>
            <span class="threshold-dot dot-pass" id="dot-pitch"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: |pitch| < 20Â° = æ­£é¢</span>
        </div>
        <div class="threshold-item">
          <span class="threshold-label">è§†çº¿ X åç§»</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-gaze-x">0.000</span>
            <span class="threshold-dot dot-pass" id="dot-gaze-x"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: |x| < 0.35 = å±…ä¸­</span>
        </div>
        <div class="threshold-item">
          <span class="threshold-label">è§†çº¿ Y åç§»</span>
          <div class="threshold-vals">
            <span class="threshold-current" id="th-gaze-y">0.000</span>
            <span class="threshold-dot dot-pass" id="dot-gaze-y"></span>
          </div>
          <span class="threshold-ref">é˜ˆå€¼: |y| < 0.35 = å±…ä¸­</span>
        </div>
      </div>
    </div>

    <!-- â‘¤ ADHD è¡Œä¸ºç‰¹å¾æ£€æµ‹ (DSM-5) -->
    <div class="section">
      <div class="section-title"><span class="icon">âš </span> ADHD è¡Œä¸ºç‰¹å¾æ£€æµ‹ (DSM-5 ä¸‰æ¨¡å¼)</div>
      <div class="adhd-panel">
        <div class="adhd-pattern" id="adhd-p1">
          <div class="adhd-pattern-status"></div>
          <div class="adhd-pattern-info">
            <div class="adhd-pattern-name">æ¨¡å¼1: è¿ç»­åˆ†å¿ƒ</div>
            <div class="adhd-pattern-desc">æœ€è¿‘ 3 å¸§å…¨éƒ¨é"ä¸“æ³¨" â†’ æ‰£ 5 åˆ†</div>
          </div>
          <div class="adhd-pattern-val" id="adhd-p1-val">0</div>
        </div>
        <div class="adhd-pattern" id="adhd-p2">
          <div class="adhd-pattern-status"></div>
          <div class="adhd-pattern-info">
            <div class="adhd-pattern-name">æ¨¡å¼2: æƒ…ç»ªæ³¢åŠ¨</div>
            <div class="adhd-pattern-desc">æƒ…ç»ªå¿«é€Ÿåˆ‡æ¢ â†’ æ‰£ 4 åˆ† (Webç‰ˆæš‚æœªå¯ç”¨)</div>
          </div>
          <div class="adhd-pattern-val" id="adhd-p2-val">â€”</div>
        </div>
        <div class="adhd-pattern" id="adhd-p3">
          <div class="adhd-pattern-status"></div>
          <div class="adhd-pattern-info">
            <div class="adhd-pattern-name">æ¨¡å¼3: æ³¨æ„åŠ›é¢‘ç¹è½¬ç§»</div>
            <div class="adhd-pattern-desc">20 å¸§å†… "åˆ†å¿ƒâ†”ä¸“æ³¨" åˆ‡æ¢ â‰¥ 5 æ¬¡ â†’ æ‰£ 3 åˆ†</div>
          </div>
          <div class="adhd-pattern-val" id="adhd-p3-val">0</div>
        </div>
      </div>
    </div>

    <!-- â‘¥ MediaPipe 478 ç‚¹æ„ŸçŸ¥å±‚ -->
    <div class="section">
      <div class="section-title"><span class="icon">â–³</span> æ„ŸçŸ¥å±‚: MediaPipe FaceMesh 478 ç‚¹</div>
      <div style="font-size:11px; color:#6a8a9a; line-height:1.5;">
        <div class="metric"><span class="metric-label">çœ¨çœ¼æ¬¡æ•°</span><span class="metric-value" id="m-blinks">0</span></div>
        <div class="metric"><span class="metric-label">æŒç»­ä¸“æ³¨æ—¶é•¿</span><span class="metric-value" id="m-focus-dur">0.0s</span></div>
        <div class="metric"><span class="metric-label">å¾®åŠ¨è®¡æ•°</span><span class="metric-value" id="m-micro">0</span></div>
        <div style="margin-top:6px; font-size:10px; color:#4a6a7a; line-height:1.4;">
          è¾“å…¥: æ‘„åƒå¤´ 640Ã—480 â†’ MediaPipe FaceMesh (refineLandmarks=true) â†’ 478ä¸ª3Dé¢éƒ¨å…³é”®ç‚¹ â†’ åŒ…å«è™¹è†œè¿½è¸ª (ç‚¹468-477) â†’ åˆ†æ EAR/å¤´éƒ¨å§¿æ€/è§†çº¿å‘é‡
        </div>
      </div>
    </div>

    <!-- â‘¦ ç»Ÿè®¡ + è¶‹åŠ¿ -->
    <div class="section">
      <div class="section-title"><span class="icon">ğŸ“Š</span> ç»Ÿè®¡ä¿¡æ¯</div>
      <div class="metric"><span class="metric-label">å¹³å‡åˆ†æ•°</span><span class="metric-value" id="m-avg">--</span></div>
      <div class="metric"><span class="metric-label">ä¸“æ³¨ç‡ (â‰¥70åˆ†)</span><span class="metric-value" id="m-focus-pct">--</span></div>
      <div class="metric"><span class="metric-label">æœ€é•¿è¿ç»­ä¸“æ³¨</span><span class="metric-value" id="m-longest">--</span></div>
      <div class="metric"><span class="metric-label">ä¸“æ³¨ä¸­æ–­æ¬¡æ•°</span><span class="metric-value" id="m-interrupts">0</span></div>
      <div class="metric"><span class="metric-label">ADHD è§¦å‘äº‹ä»¶</span><span class="metric-value" id="m-adhd-events">0</span></div>
      <div class="metric"><span class="metric-label">è¯­éŸ³æé†’æ¬¡æ•°</span><span class="metric-value" id="m-voice-count">0</span></div>
    </div>

    <div class="section">
      <div class="section-title"><span class="icon">ã€°</span> æ³¨æ„åŠ›è¶‹åŠ¿</div>
      <canvas class="chart-canvas" id="historyChart"></canvas>
    </div>

    <!-- â‘§ ä¸ªæ€§åŒ–åŸºçº¿ (CalibrationSystem + FacialModeling + EMA) -->
    <div class="section">
      <div class="section-title"><span class="icon">âŠ•</span> ä¸ªæ€§åŒ–åŸºçº¿ <span class="baseline-badge default" id="calibBadge">æœªæ ¡å‡†</span></div>
      <div class="metric"><span class="metric-label">EAR åŸºçº¿</span><span class="metric-value" id="m-bl-ear">0.250 (é»˜è®¤)</span></div>
      <div class="metric"><span class="metric-label">è§†çº¿ä¸­å¿ƒ</span><span class="metric-value" id="m-bl-gaze">(0.00, 0.00)</span></div>
      <div class="metric"><span class="metric-label">è§†çº¿å®¹å·®</span><span class="metric-value" id="m-bl-tol">0.35 (é»˜è®¤)</span></div>
      <div class="metric"><span class="metric-label">å¤´éƒ¨åŸºçº¿</span><span class="metric-value" id="m-bl-head">(0.0Â°, 0.0Â°)</span></div>
      <div class="metric"><span class="metric-label">EMA æ¼‚ç§»</span><span class="metric-value" id="m-bl-ema">Î±=0.01</span></div>
      <div style="margin-top:6px;">
        <button class="btn-ctrl" id="btnRecalib" onclick="AttentionMonitor.recalibrate()" style="font-size:10px;">é‡æ–°æ ¡å‡†</button>
      </div>
    </div>

    <!-- â‘¨ æ§åˆ¶ -->
    <div class="section">
      <div class="section-title"><span class="icon">âŠ</span> æ§åˆ¶</div>
      <div class="controls">
        <button class="btn-ctrl active" id="btnVoice" onclick="AttentionMonitor.toggleVoice()">è¯­éŸ³æé†’</button>
        <button class="btn-ctrl" id="btnLandmarks" onclick="AttentionMonitor.toggleLandmarks()">ç‰¹å¾ç‚¹</button>
        <button class="btn-ctrl export" id="btnExport" onclick="AttentionMonitor.exportReport()">å¯¼å‡ºæŠ¥å‘Š</button>
        <button class="btn-ctrl danger" id="btnReset" onclick="AttentionMonitor.resetStats()">é‡ç½®</button>
      </div>
    </div>
  </div>
</div>

<!-- MediaPipe FaceMesh (script æ ‡ç­¾åŠ è½½ï¼Œå…¼å®¹æ‰€æœ‰æµè§ˆå™¨) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

<script>
// ============================================================================
// AttentionMonitor SDK v2.2 â€” with CalibrationSystem + FacialModeling + EMA
// ============================================================================
var AttentionMonitor = (function() {
  'use strict';

  var sdk = {
    version: '2.2.0',
    running: false,
    sessionStartTime: null,
    showLandmarks: false,
    voiceEnabled: true,
    _callbacks: {},
    on: function(event, fn) { if (!this._callbacks[event]) this._callbacks[event] = []; this._callbacks[event].push(fn); },
    _emit: function(event, data) { var cbs = this._callbacks[event] || []; for (var i = 0; i < cbs.length; i++) cbs[i](data); }
  };

  // === å¸¸é‡ (ä¸ ui.py ä¸€è‡´) ===
  var R_EYE = [33, 160, 158, 133, 153, 144];
  var L_EYE = [362, 385, 387, 263, 373, 380];
  var POSE_LANDMARKS = { nose_tip: 1, chin: 152, left_eye_outer: 263, right_eye_outer: 33, left_mouth: 291, right_mouth: 61 };
  var RIGHT_IRIS = [468, 469, 470, 471, 472];
  var LEFT_IRIS = [473, 474, 475, 476, 477];

  // === AttentionConfig (ui.py ç¬¬ 50-60 è¡Œ) ===
  var config = { ear_thresh: 0.21, ear_consec_frames: 1, yaw_thresh_deg: 20.0, pitch_thresh_deg: 20.0, roll_thresh_deg: 25.0, gaze_off_center: 0.35, min_face_conf: 0.5 };

  // === AttentionAnalyzer (ui.py ç¬¬ 92-311 è¡Œ) ===
  var attentionAnalyzer = {
    closed_counter: 0, blinks: 0,
    ear_history: [], gaze_history: [], pose_history: [],
    current_state: { attention_label: 'åˆå§‹åŒ–ä¸­', ear_left: 0, ear_right: 0, yaw: 0, pitch: 0, roll: 0, gaze_x: 0, gaze_y: 0, blink_count: 0, face_detected: false },

    eyeAspectRatio: function(pts, indices) {
      if (!pts || indices.length < 6) return 0.3;
      var p = []; for (var i = 0; i < indices.length; i++) p.push(pts[indices[i]]);
      var A = Math.hypot(p[1].x-p[5].x, p[1].y-p[5].y);
      var B = Math.hypot(p[2].x-p[4].x, p[2].y-p[4].y);
      var C = Math.hypot(p[0].x-p[3].x, p[0].y-p[3].y);
      return (A+B)/(2.0*C+1e-6);
    },
    headPose: function(pts) {
      var nose=pts[POSE_LANDMARKS.nose_tip], chin=pts[POSE_LANDMARKS.chin], le=pts[POSE_LANDMARKS.left_eye_outer], re=pts[POSE_LANDMARKS.right_eye_outer];
      var emx=(le.x+re.x)/2, edx=Math.abs(le.x-re.x), yaw=((nose.x-emx)/(edx+1e-6))*60;
      var emy=(le.y+re.y)/2, fh=Math.abs(chin.y-emy), npy=(nose.y-emy)/(fh+1e-6), pitch=(npy-0.35)*80;
      var roll=Math.atan2(re.y-le.y, re.x-le.x)*(180/Math.PI);
      return {pitch:pitch,yaw:yaw,roll:roll};
    },
    irisCenter: function(pts, indices) {
      var cx=0,cy=0; for(var i=0;i<indices.length;i++){cx+=pts[indices[i]].x;cy+=pts[indices[i]].y;} return{x:cx/indices.length,y:cy/indices.length};
    },
    gazeVector: function(pts, eyeIdx, ic) {
      var ep=[]; for(var i=0;i<eyeIdx.length;i++) ep.push(pts[eyeIdx[i]]);
      var xn=Infinity,xx=-Infinity,yn=Infinity,yx=-Infinity;
      for(var i=0;i<ep.length;i++){var p=ep[i]; if(p.x<xn)xn=p.x; if(p.x>xx)xx=p.x; if(p.y<yn)yn=p.y; if(p.y>yx)yx=p.y;}
      var cx=(xn+xx)/2,cy=(yn+yx)/2;
      var nx=xx===xn?0:(ic.x-cx)/((xx-xn)/2), ny=yx===yn?0:(ic.y-cy)/((yx-yn)/2);
      return{x:Math.max(-1.5,Math.min(1.5,nx)),y:Math.max(-1.5,Math.min(1.5,ny))};
    },
    attentionLabel: function(el,er,yaw,pitch,g) {
      if(!(el>config.ear_thresh&&er>config.ear_thresh)) return 'çœ¼ç›é—­åˆ';
      if(!(Math.abs(yaw)<config.yaw_thresh_deg&&Math.abs(pitch)<config.pitch_thresh_deg)) return 'è§†çº¿åç¦»';
      if(!(Math.abs(g.x)<config.gaze_off_center&&Math.abs(g.y)<config.gaze_off_center)) return 'è§†çº¿åç§»';
      return 'ä¸“æ³¨';
    },
    analyzeFrame: function(landmarks) {
      var pts=landmarks, label='æœªæ£€æµ‹åˆ°é¢éƒ¨', el=0,er=0, euler={pitch:0,yaw:0,roll:0}, gz={x:0,y:0};
      if(pts&&pts.length>=478){
        er=this.eyeAspectRatio(pts,R_EYE); el=this.eyeAspectRatio(pts,L_EYE);
        if(el<config.ear_thresh&&er<config.ear_thresh){this.closed_counter++;}
        else{if(this.closed_counter>=config.ear_consec_frames)this.blinks++;this.closed_counter=0;}
        euler=this.headPose(pts);
        var icr=this.irisCenter(pts,RIGHT_IRIS),icl=this.irisCenter(pts,LEFT_IRIS);
        var gr=this.gazeVector(pts,R_EYE,icr),gl=this.gazeVector(pts,L_EYE,icl);
        gz={x:(gr.x+gl.x)/2,y:(gr.y+gl.y)/2};
        // æ ¡å‡†åï¼šç”¨ä¸ªäººè§†çº¿ä¸­å¿ƒåç§»åŸå§‹æ•°æ®
        if(calibrationSystem.isCalibrated()){
          gz.x -= calibrationSystem.reference_gaze_center[0];
          gz.y -= calibrationSystem.reference_gaze_center[1];
        }
        label=this.attentionLabel(el,er,euler.yaw,euler.pitch,gz);
      }
      this.current_state={attention_label:label,ear_left:el,ear_right:er,yaw:euler.yaw,pitch:euler.pitch,roll:euler.roll,gaze_x:gz.x,gaze_y:gz.y,blink_count:this.blinks,face_detected:pts&&pts.length>=478};
      this.ear_history.push((el+er)/2); if(this.ear_history.length>300)this.ear_history.shift();
      this.gaze_history.push(Math.hypot(gz.x,gz.y)); if(this.gaze_history.length>300)this.gaze_history.shift();
      this.pose_history.push(Math.abs(euler.yaw)+Math.abs(euler.pitch)); if(this.pose_history.length>300)this.pose_history.shift();
      return this.current_state;
    },
    reset: function(){this.closed_counter=0;this.blinks=0;this.ear_history.length=0;this.gaze_history.length=0;this.pose_history.length=0;}
  };

  // === OptimizedAttentionScoringSystem (ui.py ç¬¬ 3387-3985 è¡Œ) ===
  var scoringSystem = {
    params: {
      ear_optimal:0.22, ear_good_threshold:0.20, ear_fair_threshold:0.18, ear_bad_threshold:0.16, ear_asymmetry_threshold:0.05,
      gaze_optimal:0.15, gaze_good_threshold:0.25, gaze_fair_threshold:0.35, gaze_bad_threshold:0.50, gaze_speed_threshold:0.8,
      head_optimal:8.0, head_good_threshold:15.0, head_fair_threshold:25.0, head_bad_threshold:35.0, head_speed_threshold:10.0,
      blink_optimal_min:10, blink_optimal_max:30, blink_too_fast:40, blink_too_slow:5, blink_cluster_threshold:5,
      short_focus_threshold:2.0, medium_focus_threshold:5.0, long_focus_threshold:10.0,
      micro_movement_freq:3.0
    },
    gaze_history:[], head_pose_history:[], ear_history:[], attention_history:[], score_history:[], timestamps:[],
    blink_timestamps:[], blink_clusters:[], current_blink_cluster:0,
    motor_movements:[], micro_movement_count:0, last_head_position:null,
    focus_start_time:null, current_focus_duration:0, longest_focus_duration:0, focus_interruptions:0,
    adhd_features:{inattention_count:0,hyperactivity_count:0,impulsivity_events:[],total_events:0},
    lastDetail:{eye:0,gaze:0,head:0,duration:0,blink:0,motor:0,emotion:0,adhd:0},

    // ç”¨äº ADHD é¢æ¿çš„è¯¦ç»†ä¿¡æ¯
    adhdDetail: { p1_triggered: false, p1_penalty: 0, p3_triggered: false, p3_transitions: 0, p3_penalty: 0 },

    calcEyeScore: function(el,er,label){
      if(label==='çœ¼ç›é—­åˆ')return 0; var avg=(el+er)/2,asym=Math.abs(el-er),s;
      if(avg>=this.params.ear_optimal)s=20;else if(avg>=this.params.ear_good_threshold)s=16;else if(avg>=this.params.ear_fair_threshold)s=12;else if(avg>=this.params.ear_bad_threshold)s=6;else s=0;
      if(asym>this.params.ear_asymmetry_threshold)s-=Math.min(5,asym*20);
      if(this.ear_history.length>=30){var st=calcStd(this.ear_history.slice(-30));if(st<0.02)s+=3;else if(st<0.04)s+=2;}
      return Math.max(0,s);
    },
    calcGazeScore: function(gx,gy,label){
      if(label==='è§†çº¿åç¦»'||label==='è§†çº¿åç§»')return 0; var m=Math.hypot(gx,gy),s;
      if(m<=this.params.gaze_optimal)s=15;else if(m<=this.params.gaze_good_threshold)s=12;else if(m<=this.params.gaze_fair_threshold)s=9;else if(m<=this.params.gaze_bad_threshold)s=5;else s=0;
      if(this.gaze_history.length>=2){var sp=Math.abs(m-this.gaze_history[this.gaze_history.length-2]);if(sp>this.params.gaze_speed_threshold)s-=Math.min(5,sp*3);}
      if(this.gaze_history.length>=60){var st=calcStd(this.gaze_history.slice(-60));if(st<0.1)s+=3;else if(st<0.2)s+=2;}
      return Math.max(0,s);
    },
    calcHeadScore: function(yaw,pitch,label){
      if(label==='è§†çº¿åç¦»')return 0; var off=Math.hypot(yaw,pitch),s;
      if(off<=this.params.head_optimal)s=12;else if(off<=this.params.head_good_threshold)s=10;else if(off<=this.params.head_fair_threshold)s=8;else if(off<=this.params.head_bad_threshold)s=4;else s=0;
      if(this.last_head_position){var mv=Math.hypot(yaw-this.last_head_position[0],pitch-this.last_head_position[1]);if(mv>this.params.head_speed_threshold)s-=Math.min(4,mv*2);}
      if(this.head_pose_history.length>=60){var st=calcStd(this.head_pose_history.slice(-60));if(st<5.0)s+=2;else if(st<10.0)s+=1;}
      return Math.max(0,s);
    },
    calcDurationScore: function(label,now){
      if(this.focus_start_time===null)return 5; var dur=(now-this.focus_start_time)/1000;
      if(dur>=this.params.long_focus_threshold)return 18;if(dur>=this.params.medium_focus_threshold)return 14;if(dur>=this.params.short_focus_threshold)return 9;return 4;
    },
    calcBlinkScore: function(el,er,now){
      if(this.ear_history.length<30)return 5;
      if(el<this.params.ear_bad_threshold&&er<this.params.ear_bad_threshold){this.blink_timestamps.push(now);this.current_blink_cluster++;}
      else{if(this.current_blink_cluster>0&&this.blink_timestamps.length>0){if(now-this.blink_timestamps[this.blink_timestamps.length-1]>500){if(this.current_blink_cluster>=this.params.blink_cluster_threshold)this.blink_clusters.push(this.current_blink_cluster);this.current_blink_cluster=0;}}}
      var rc=[]; for(var i=0;i<this.blink_timestamps.length;i++){if(now-this.blink_timestamps[i]<=10000)rc.push(this.blink_timestamps[i]);}
      var rate=(rc.length/10)*60, s;
      if(rate>=this.params.blink_optimal_min&&rate<=this.params.blink_optimal_max)s=8;else if(rate>this.params.blink_too_fast)s=3;else if(rate<this.params.blink_too_slow)s=4;else s=6;
      if(this.blink_clusters.length>0&&this.blink_clusters[this.blink_clusters.length-1]>=3)s-=2;
      return Math.max(0,s);
    },
    calcMotorScore: function(yaw,pitch,now){
      if(!this.last_head_position){this.last_head_position=[yaw,pitch];return 5;}
      var mv=Math.hypot(yaw-this.last_head_position[0],pitch-this.last_head_position[1]);
      if(mv>0.5&&mv<5.0){this.micro_movement_count++;this.motor_movements.push({timestamp:now,movement:mv});}
      var rm=[]; for(var i=0;i<this.motor_movements.length;i++){if(now-this.motor_movements[i].timestamp<=5000)rm.push(this.motor_movements[i]);}
      var freq=rm.length/5.0, s=8;
      if(freq>this.params.micro_movement_freq){s-=4;this.adhd_features.hyperactivity_count++;}else if(freq>this.params.micro_movement_freq/2)s-=2;
      this.last_head_position=[yaw,pitch];return Math.max(0,s);
    },
    calcEmotionAdjustment: function(){return 0;},

    // === EMA è‡ªé€‚åº”åŸºçº¿ (ui.py update_adaptive_params) ===
    user_ear_baseline: 0.25,
    user_gaze_stability: 0.0,
    user_head_stability: 0.0,
    updateAdaptiveParams: function(state) {
      if (!state.face_detected) return;
      var alpha = 0.01;
      var ear_avg = (state.ear_left + state.ear_right) / 2;
      this.user_ear_baseline = (1 - alpha) * this.user_ear_baseline + alpha * ear_avg;
      this.user_gaze_stability = (1 - alpha) * this.user_gaze_stability + alpha * Math.hypot(state.gaze_x, state.gaze_y);
      this.user_head_stability = (1 - alpha) * this.user_head_stability + alpha * (Math.abs(state.yaw) + Math.abs(state.pitch));
    },

    detectAdhdFeatures: function(state,now){
      var adj=0, label=state.attention_label;
      this.adhdDetail.p1_triggered=false; this.adhdDetail.p1_penalty=0;
      this.adhdDetail.p3_triggered=false; this.adhdDetail.p3_transitions=0; this.adhdDetail.p3_penalty=0;

      if(label!=='ä¸“æ³¨'&&label!=='åˆå§‹åŒ–ä¸­'&&label!=='æœªæ£€æµ‹åˆ°é¢éƒ¨'){
        this.adhd_features.inattention_count++;
        if(this.attention_history.length>=3){
          var r3=this.attention_history.slice(-3),allD=true,dc=0;
          for(var i=0;i<r3.length;i++){if(r3[i]!=='ä¸“æ³¨')dc++;else allD=false;}
          if(allD){adj-=5;this.adhdDetail.p1_triggered=true;this.adhdDetail.p1_penalty=-5;}
          else if(dc>=2){adj-=3;this.adhdDetail.p1_triggered=true;this.adhdDetail.p1_penalty=-3;}
        }
      }
      if(this.attention_history.length>=20){
        var pat=this.attention_history.slice(-20),tr=0;
        for(var i=1;i<pat.length;i++){if(pat[i]==='ä¸“æ³¨'&&pat[i-1]!=='ä¸“æ³¨')tr++;}
        this.adhdDetail.p3_transitions=tr;
        if(tr>=5){adj-=3;this.adhdDetail.p3_triggered=true;this.adhdDetail.p3_penalty=-3;this.adhd_features.total_events++;}
      }
      return adj;
    },

    nonlinearScale: function(s){if(s>=80)return 80+(s-80)*0.8;if(s>=60)return s;if(s>=40)return 40+(s-40)*1.2;return s*1.5;},

    updateFocusState: function(label,score,now){
      if(label==='ä¸“æ³¨'&&score>=65){if(this.focus_start_time===null){this.focus_start_time=now;this.current_focus_duration=0;}this.current_focus_duration=(now-this.focus_start_time)/1000;if(this.current_focus_duration>this.longest_focus_duration)this.longest_focus_duration=this.current_focus_duration;}
      else{if(this.focus_start_time!==null){this.focus_interruptions++;this.focus_start_time=null;this.current_focus_duration=0;}}
    },

    // ä¸»å…¥å£ â€” é¢å¤–ä¿å­˜ä¸­é—´æ­¥éª¤ä¾› UI å±•ç¤º
    _lastCalcSteps: { base:0, preScale:0, postScale:0, final:0 },

    calculate: function(state){
      var now=performance.now(); this.timestamps.push(now);
      var eye=this.calcEyeScore(state.ear_left,state.ear_right,state.attention_label);
      var gaze=this.calcGazeScore(state.gaze_x,state.gaze_y,state.attention_label);
      var head=this.calcHeadScore(state.yaw,state.pitch,state.attention_label);
      var duration=this.calcDurationScore(state.attention_label,now);
      var blink=this.calcBlinkScore(state.ear_left,state.ear_right,now);
      var motor=this.calcMotorScore(state.yaw,state.pitch,now);

      var base=eye+gaze+head+duration+blink+motor;
      if(!state.face_detected) base=Math.max(0,base*0.6);
      var emo=this.calcEmotionAdjustment();
      var adhd=this.detectAdhdFeatures(state,now);
      var preScale=base+emo+adhd;
      var postScale=this.nonlinearScale(preScale);
      var final_=Math.max(0,Math.min(100,postScale));

      this.updateFocusState(state.attention_label,final_,now);

      this.attention_history.push(state.attention_label); if(this.attention_history.length>600)this.attention_history.shift();
      this.gaze_history.push(Math.hypot(state.gaze_x,state.gaze_y)); if(this.gaze_history.length>300)this.gaze_history.shift();
      this.head_pose_history.push(Math.abs(state.yaw)+Math.abs(state.pitch)); if(this.head_pose_history.length>300)this.head_pose_history.shift();
      this.ear_history.push((state.ear_left+state.ear_right)/2); if(this.ear_history.length>300)this.ear_history.shift();
      this.score_history.push(final_); if(this.score_history.length>600)this.score_history.shift();

      this.lastDetail={eye:eye,gaze:gaze,head:head,duration:duration,blink:blink,motor:motor,emotion:emo,adhd:adhd};
      this._lastCalcSteps={base:base,preScale:preScale,postScale:postScale,final:Math.round(final_)};
      this.updateAdaptiveParams(state);
      return Math.round(final_);
    },

    reset: function(){
      this.gaze_history.length=0;this.head_pose_history.length=0;this.ear_history.length=0;this.attention_history.length=0;this.score_history.length=0;this.timestamps.length=0;
      this.blink_timestamps.length=0;this.blink_clusters.length=0;this.motor_movements.length=0;
      this.current_blink_cluster=0;this.micro_movement_count=0;this.last_head_position=null;
      this.focus_start_time=null;this.current_focus_duration=0;this.longest_focus_duration=0;this.focus_interruptions=0;
      this.adhd_features={inattention_count:0,hyperactivity_count:0,impulsivity_events:[],total_events:0};
    }
  };

  // === CalibrationSystem (ui.py ç¬¬ 4346-4578 è¡Œ) ===
  var calibrationSystem = {
    active: false,
    step: 0,
    stepNames: ['ä¸­å¿ƒ','å·¦ä¸Š','å³ä¸Š','å·¦ä¸‹','å³ä¸‹'],
    positions: [{x:50,y:50},{x:15,y:15},{x:85,y:15},{x:15,y:85},{x:85,y:85}],
    framesNeeded: 60,
    framesCollected: 0,
    gazeData: [],
    results: {},
    reference_gaze_center: [0, 0],
    gaze_tolerance: 0.35,

    start: function() {
      this.active = true; this.step = 0; this.framesCollected = 0;
      this.gazeData = []; this.results = {};
      var ov = document.getElementById('calibOverlay');
      ov.classList.add('active');
      this.updateDotPosition();
      this.updateUI();
    },

    updateDotPosition: function() {
      var pos = this.positions[this.step];
      var dot = document.getElementById('calibDot');
      var ring = document.getElementById('calibRing');
      dot.style.left = pos.x + '%'; dot.style.top = pos.y + '%';
      ring.style.left = pos.x + '%'; ring.style.top = pos.y + '%';
    },

    updateUI: function() {
      var names = ['è¯·æ³¨è§† å±å¹•ä¸­å¤®','è¯·æ³¨è§† å·¦ä¸Šè§’','è¯·æ³¨è§† å³ä¸Šè§’','è¯·æ³¨è§† å·¦ä¸‹è§’','è¯·æ³¨è§† å³ä¸‹è§’'];
      document.getElementById('calibStepText').textContent = names[this.step] + ' (' + (this.step+1) + '/5)';
      document.getElementById('calibProgressText').textContent = this.framesCollected + ' / ' + this.framesNeeded;
      var pct = this.framesCollected / this.framesNeeded;
      var offset = 132 * (1 - pct);
      document.getElementById('calibRingFill').setAttribute('stroke-dashoffset', offset);
    },

    collectFrame: function(gx, gy) {
      if (!this.active) return false;
      this.gazeData.push({x: gx, y: gy});
      this.framesCollected++;
      this.updateUI();

      if (this.framesCollected >= this.framesNeeded) {
        this.completeStep();
        this.step++;
        if (this.step >= 5) {
          this.finalize();
          return true; // calibration done
        }
        this.framesCollected = 0; this.gazeData = [];
        this.updateDotPosition(); this.updateUI();
      }
      return false;
    },

    completeStep: function() {
      // å–æœ€å 30 å¸§ï¼ˆæœ€ç¨³å®šçš„éƒ¨åˆ†ï¼‰
      var data = this.gazeData.slice(-30);
      var sx = 0, sy = 0;
      for (var i = 0; i < data.length; i++) { sx += data[i].x; sy += data[i].y; }
      var avgX = sx / data.length, avgY = sy / data.length;
      var sqx = 0, sqy = 0;
      for (var i = 0; i < data.length; i++) { sqx += (data[i].x - avgX) * (data[i].x - avgX); sqy += (data[i].y - avgY) * (data[i].y - avgY); }
      var stdX = Math.sqrt(sqx / data.length), stdY = Math.sqrt(sqy / data.length);
      this.results[this.stepNames[this.step]] = { avg: [avgX, avgY], std: [stdX, stdY], samples: data.length };
    },

    finalize: function() {
      this.active = false;
      document.getElementById('calibOverlay').classList.remove('active');
      // ç”¨ä¸­å¿ƒæ ¡å‡†ç»“æœä½œä¸ºå‚è€ƒç‚¹
      var center = this.results['ä¸­å¿ƒ'];
      if (center) {
        this.reference_gaze_center = center.avg;
        this.gaze_tolerance = Math.max(0.15, 2 * Math.max(center.std[0], center.std[1]));
      }
      // ä¸æ›¿æ¢ gaze_off_centerï¼Œä¿æŒ 0.35 ä½œä¸ºåˆ¤æ–­é˜ˆå€¼
      // æ ¡å‡†çš„ä½œç”¨æ˜¯é€šè¿‡ reference_gaze_center åç§»åŸå§‹æ•°æ®ï¼Œè€Œéæ”¶ç´§å®¹å·®
      // gaze_tolerance ä»…è®°å½•ç”¨äºä¾§æ æ˜¾ç¤ºä¸ªäººç¨³å®šæ€§
      console.log('[Calibration] å®Œæˆ. è§†çº¿ä¸­å¿ƒ:', this.reference_gaze_center, 'å®¹å·®:', this.gaze_tolerance, '(gaze_off_center ä¿æŒ 0.35)');
    },

    skip: function() {
      this.active = false;
      document.getElementById('calibOverlay').classList.remove('active');
      console.log('[Calibration] å·²è·³è¿‡ï¼Œä½¿ç”¨é»˜è®¤é˜ˆå€¼');
    },

    isCalibrated: function() { return Object.keys(this.results).length >= 5; }
  };

  // === FacialModeling (ui.py ç¬¬ 3184-3376 è¡Œ) ===
  var facialModel = {
    calibrated: false,
    baseline_ear: 0.25,
    baseline_gaze: 0.0,
    baseline_head: { yaw: 0, pitch: 0 },
    frames: [],
    default_ear: 0.25,

    recordFrame: function(state) {
      if (!state.face_detected) return;
      this.frames.push({
        ear: (state.ear_left + state.ear_right) / 2,
        gaze: Math.hypot(state.gaze_x, state.gaze_y),
        yaw: state.yaw, pitch: state.pitch
      });
    },

    computeBaseline: function() {
      if (this.frames.length < 5) return;
      // å–æœ€å 5 å¸§å¹³å‡
      var last5 = this.frames.slice(-5);
      var se = 0, sg = 0, sy = 0, sp = 0;
      for (var i = 0; i < last5.length; i++) {
        se += last5[i].ear; sg += last5[i].gaze;
        sy += last5[i].yaw; sp += last5[i].pitch;
      }
      this.baseline_ear = se / 5;
      this.baseline_gaze = sg / 5;
      this.baseline_head = { yaw: sy / 5, pitch: sp / 5 };
      this.calibrated = true;

      // æ ¹æ®ä¸ªäºº baseline è°ƒæ•´è¯„åˆ†é˜ˆå€¼
      this.applyPersonalizedThresholds();
      console.log('[FacialModeling] åŸºçº¿å»ºç«‹. EAR:', this.baseline_ear.toFixed(3), 'Gaze:', this.baseline_gaze.toFixed(3));
    },

    applyPersonalizedThresholds: function() {
      if (!this.calibrated) return;
      // æŒ‰æ¯”ä¾‹è°ƒæ•´ EAR é˜ˆå€¼ï¼šå¦‚æœä¸ªäºº baseline åä½ï¼Œé™ä½æ‰€æœ‰ EAR é˜ˆå€¼
      var ratio = this.baseline_ear / this.default_ear;
      ratio = Math.max(0.7, Math.min(1.3, ratio)); // é™åˆ¶åœ¨ 0.7-1.3 èŒƒå›´
      scoringSystem.params.ear_optimal = 0.22 * ratio;
      scoringSystem.params.ear_good_threshold = 0.20 * ratio;
      scoringSystem.params.ear_fair_threshold = 0.18 * ratio;
      scoringSystem.params.ear_bad_threshold = 0.16 * ratio;
      config.ear_thresh = 0.21 * ratio;
    },

    reset: function() {
      this.calibrated = false; this.frames = [];
      this.baseline_ear = 0.25; this.baseline_gaze = 0.0;
      this.baseline_head = { yaw: 0, pitch: 0 };
    }
  };

  // === VoiceReminderSystem (ui.py ç¬¬ 674-800 è¡Œ) ===
  var voiceReminder = {
    lastReminderTime:0, cooldown:15000, isSpeaking:false, reminderCount:0,
    messages:['è¯·æ³¨æ„é›†ä¸­æ³¨æ„åŠ›å“¦','çœ‹çœ‹å±å¹•ï¼Œç»§ç»­å­¦ä¹ å§','å°æœ‹å‹ï¼Œè¦è®¤çœŸå¬è¯¾å“¦','æ³¨æ„åŠ›å›æ¥ï¼ŒåŠ æ²¹ï¼','çœ¼ç›çœ‹è¿™é‡Œï¼Œç»§ç»­åŠªåŠ›'],
    check:function(score,label){
      if(!sdk.voiceEnabled||this.isSpeaking)return;var now=performance.now();if(now-this.lastReminderTime<this.cooldown)return;
      if(score<40&&label!=='ä¸“æ³¨'&&label!=='æœªæ£€æµ‹åˆ°é¢éƒ¨'&&label!=='åˆå§‹åŒ–ä¸­'){this.speak();this.lastReminderTime=now;this.reminderCount++;}
    },
    speak:function(){
      if(!('speechSynthesis' in window))return;
      var text=this.messages[Math.floor(Math.random()*this.messages.length)];
      var msg=new SpeechSynthesisUtterance(text);msg.lang='zh-CN';msg.rate=0.9;msg.pitch=1.1;this.isSpeaking=true;
      var ind=document.getElementById('voiceIndicator');ind.textContent=text;ind.classList.add('show');
      var self=this;msg.onend=function(){self.isSpeaking=false;ind.classList.remove('show');};
      speechSynthesis.speak(msg);
      sdk._emit('voiceReminder',{text:text,timestamp:new Date().toISOString()});
    },
    reset:function(){this.lastReminderTime=0;this.reminderCount=0;if('speechSynthesis' in window)speechSynthesis.cancel();}
  };

  // === è¾…åŠ©å‡½æ•° ===
  function calcStd(arr){if(arr.length===0)return 0;var s=0;for(var i=0;i<arr.length;i++)s+=arr[i];var m=s/arr.length;var sq=0;for(var i=0;i<arr.length;i++)sq+=(arr[i]-m)*(arr[i]-m);return Math.sqrt(sq/arr.length);}
  function getScoreColor(s){if(s>=70)return'#36d399';if(s>=40)return'#f59e0b';return'#ff4a4a';}
  function formatDuration(s){var h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=Math.floor(s%60);return(h<10?'0':'')+h+':'+(m<10?'0':'')+m+':'+(ss<10?'0':'')+ss;}

  // === UI æ›´æ–° ===
  var scoreHistory=[], totalFrames=0, focusedFrames=0;
  var lastFpsTime=0, fpsCounter=0, currentFps=0;
  var sessionTimeline=[], lastTimelineSample=0;

  function updateUI(state, score) {
    var d = scoringSystem.lastDetail;
    var steps = scoringSystem._lastCalcSteps;

    // --- åˆ†æ•°åœ† ---
    var color=getScoreColor(score);
    document.getElementById('scoreCircle').style.borderColor=color;
    document.getElementById('scoreNumber').textContent=score;
    document.getElementById('scoreNumber').style.color=color;

    // --- æ³¨æ„åŠ›æ ‡ç­¾ ---
    var tag=document.getElementById('attentionTag');
    tag.textContent=state.attention_label;
    tag.style.color=state.attention_label==='ä¸“æ³¨'?'#36d399':'#ff6a6a';

    // --- â‘¡ è®¡ç®—æ­¥éª¤ ---
    document.getElementById('cs-base-expr').textContent = '= '+d.eye+'+'+d.gaze+'+'+d.head+'+'+d.duration+'+'+d.blink+'+'+d.motor;
    document.getElementById('cs-base').textContent = '= '+Math.round(steps.base);
    document.getElementById('cs-emo').textContent = d.emotion>=0?'+'+d.emotion.toFixed(1):d.emotion.toFixed(1);
    document.getElementById('cs-adhd-expr').textContent = d.adhd<0?'æ£€æµ‹åˆ°å¼‚å¸¸è¡Œä¸ºæ¨¡å¼':'DSM-5 è¡Œä¸ºæ¨¡å¼æ­£å¸¸';
    document.getElementById('cs-adhd').textContent = d.adhd>=0?'+'+d.adhd:''+d.adhd;
    document.getElementById('cs-adhd').style.color = d.adhd<0?'#ff6a6a':'#8899aa';
    document.getElementById('cs-scale-expr').textContent = 'nonlinear('+Math.round(steps.preScale)+')';
    document.getElementById('cs-scale').textContent = '= '+Math.round(steps.postScale);
    document.getElementById('cs-final').textContent = steps.final;
    document.getElementById('cs-final').style.color = getScoreColor(steps.final);

    // --- â‘¢ å…­ç»´è¯„åˆ† ---
    updateDim('eye', d.eye, 25, state);
    updateDim('gaze', d.gaze, 20, state);
    updateDim('head', d.head, 15, state);
    updateDim('duration', d.duration, 20, state);
    updateDim('blink', d.blink, 10, state);
    updateDim('motor', d.motor, 10, state);

    // åŠ¨æ€è¯´æ˜æ–‡å­—
    var earAvg=(state.ear_left+state.ear_right)/2;
    document.getElementById('exp-eye').textContent = 'EAR='+earAvg.toFixed(3)+(earAvg>=0.22?' (ä¼˜ç§€)':earAvg>=0.20?' (è‰¯å¥½)':earAvg>=0.18?' (ä¸€èˆ¬)':' (åä½)');
    var gazeMag=Math.hypot(state.gaze_x,state.gaze_y);
    document.getElementById('exp-gaze').textContent = 'åç§»é‡='+gazeMag.toFixed(3)+(gazeMag<=0.15?' (ä¼˜ç§€)':gazeMag<=0.25?' (è‰¯å¥½)':gazeMag<=0.35?' (ä¸€èˆ¬)':' (åç¦»)');
    var headOff=Math.hypot(state.yaw,state.pitch);
    document.getElementById('exp-head').textContent = 'åç§»='+headOff.toFixed(1)+'Â°'+(headOff<=8?' (ä¼˜ç§€)':headOff<=15?' (è‰¯å¥½)':headOff<=25?' (ä¸€èˆ¬)':' (åç¦»)');
    document.getElementById('exp-duration').textContent = 'å·²æŒç»­ '+scoringSystem.current_focus_duration.toFixed(1)+'s'+(scoringSystem.current_focus_duration>=10?' (ä¼˜ç§€)':scoringSystem.current_focus_duration>=5?' (è‰¯å¥½)':scoringSystem.current_focus_duration>=2?' (ä¸€èˆ¬)':' (åˆšå¼€å§‹)');

    // --- â‘£ é˜ˆå€¼å¯¹ç…§ ---
    setThreshold('th-ear-l', state.ear_left.toFixed(3), 'dot-ear-l', state.ear_left>config.ear_thresh);
    setThreshold('th-ear-r', state.ear_right.toFixed(3), 'dot-ear-r', state.ear_right>config.ear_thresh);
    setThreshold('th-yaw', Math.abs(state.yaw).toFixed(1)+'Â°', 'dot-yaw', Math.abs(state.yaw)<config.yaw_thresh_deg);
    setThreshold('th-pitch', Math.abs(state.pitch).toFixed(1)+'Â°', 'dot-pitch', Math.abs(state.pitch)<config.pitch_thresh_deg);
    setThreshold('th-gaze-x', Math.abs(state.gaze_x).toFixed(3), 'dot-gaze-x', Math.abs(state.gaze_x)<config.gaze_off_center);
    setThreshold('th-gaze-y', Math.abs(state.gaze_y).toFixed(3), 'dot-gaze-y', Math.abs(state.gaze_y)<config.gaze_off_center);

    // --- â‘¤ ADHD é¢æ¿ ---
    var ad=scoringSystem.adhdDetail;
    var p1=document.getElementById('adhd-p1');
    p1.className='adhd-pattern'+(ad.p1_triggered?' triggered':'');
    document.getElementById('adhd-p1-val').textContent=ad.p1_triggered?ad.p1_penalty:'0';

    var p3=document.getElementById('adhd-p3');
    p3.className='adhd-pattern'+(ad.p3_triggered?' triggered':'');
    document.getElementById('adhd-p3-val').textContent=ad.p3_triggered?ad.p3_penalty:'0 ('+ad.p3_transitions+'/5)';

    // --- ADHD æµ®å±‚ ---
    var adhdOv=document.getElementById('adhdAlertOverlay');
    if(d.adhd<-3){adhdOv.textContent=d.adhd<=-5?'ADHD: è¿ç»­åˆ†å¿ƒ':'ADHD: æ³¨æ„åŠ›é¢‘ç¹è½¬ç§»';adhdOv.classList.add('show');}
    else adhdOv.classList.remove('show');

    // --- â‘¥ æ„ŸçŸ¥å±‚ ---
    document.getElementById('m-blinks').textContent=state.blink_count;
    document.getElementById('m-focus-dur').textContent=scoringSystem.current_focus_duration.toFixed(1)+'s';
    document.getElementById('m-micro').textContent=scoringSystem.micro_movement_count;

    // --- â‘¦ ç»Ÿè®¡ ---
    totalFrames++;
    if(score>=70)focusedFrames++;
    updateStatsUI();

    if(sdk.sessionStartTime){document.getElementById('sessionTag').textContent=formatDuration((Date.now()-sdk.sessionStartTime)/1000);}

    scoreHistory.push(score); if(scoreHistory.length>200)scoreHistory.shift();
    drawHistoryChart();

    var now=Date.now();
    if(now-lastTimelineSample>=1000){
      sessionTimeline.push({t:now,score:score,label:state.attention_label,detail:{eye:d.eye,gaze:d.gaze,head:d.head,duration:d.duration,blink:d.blink,motor:d.motor,adhd:d.adhd}});
      lastTimelineSample=now;
    }
    sdk._emit('scoreUpdate',{score:score,label:state.attention_label,detail:d,timestamp:new Date().toISOString()});
  }

  function updateDim(id,val,max,state){
    document.getElementById('bar-'+id).style.width=(val/max*100)+'%';
    document.getElementById('val-'+id).textContent=Math.round(val)+'/'+max;
    document.getElementById('val-'+id).style.color=val>=max*0.7?'#36d399':val>=max*0.4?'#f59e0b':'#ff6a6a';
  }

  function setThreshold(valId,text,dotId,pass){
    document.getElementById(valId).textContent=text;
    document.getElementById(valId).style.color=pass?'#36d399':'#ff6a6a';
    var dot=document.getElementById(dotId);
    dot.className='threshold-dot '+(pass?'dot-pass':'dot-fail');
  }

  function updateStatsUI(){
    if(scoreHistory.length>0){var s=0;for(var i=0;i<scoreHistory.length;i++)s+=scoreHistory[i];document.getElementById('m-avg').textContent=(s/scoreHistory.length).toFixed(1);}
    document.getElementById('m-focus-pct').textContent=totalFrames>0?(focusedFrames/totalFrames*100).toFixed(1)+'%':'--';
    document.getElementById('m-longest').textContent=scoringSystem.longest_focus_duration.toFixed(1)+'s';
    document.getElementById('m-interrupts').textContent=scoringSystem.focus_interruptions;
    document.getElementById('m-adhd-events').textContent=scoringSystem.adhd_features.total_events;
    document.getElementById('m-voice-count').textContent=voiceReminder.reminderCount;
  }

  function drawHistoryChart(){
    var canvas=document.getElementById('historyChart'),c=canvas.getContext('2d');
    var w=canvas.width=canvas.clientWidth*2,h=canvas.height=canvas.clientHeight*2;
    c.clearRect(0,0,w,h); if(scoreHistory.length<2)return;
    var y70=h-(70/100)*h;
    c.strokeStyle='rgba(255,180,0,0.3)';c.lineWidth=1;c.setLineDash([6,4]);c.beginPath();c.moveTo(0,y70);c.lineTo(w,y70);c.stroke();c.setLineDash([]);
    c.beginPath();var step=w/(scoreHistory.length-1);
    for(var i=0;i<scoreHistory.length;i++){var x=i*step,y=h-(scoreHistory[i]/100)*h;if(i===0)c.moveTo(x,y);else c.lineTo(x,y);}
    c.strokeStyle='#4a9eff';c.lineWidth=2;c.stroke();
    var grad=c.createLinearGradient(0,0,0,h);grad.addColorStop(0,'rgba(74,158,255,0.3)');grad.addColorStop(1,'rgba(74,158,255,0)');
    c.lineTo(w,h);c.lineTo(0,h);c.closePath();c.fillStyle=grad;c.fill();
  }

  // === MediaPipe FaceMesh ===
  var faceMesh=null, camera=null, canvasCtx=null;

  function initFaceMesh(){
    canvasCtx=document.getElementById('overlay').getContext('2d');
    faceMesh=new FaceMesh({locateFile:function(f){return'https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/'+f;}});
    faceMesh.setOptions({maxNumFaces:1,refineLandmarks:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
    faceMesh.onResults(function(results){
      var ce=document.getElementById('overlay');
      canvasCtx.clearRect(0,0,ce.width,ce.height);
      if(results.multiFaceLandmarks&&results.multiFaceLandmarks.length>0){
        var lm=results.multiFaceLandmarks[0];

        // --- æ ¡å‡†æ¨¡å¼ï¼šæ”¶é›†æ•°æ®è€Œéè¯„åˆ† ---
        if(calibrationSystem.active){
          var st=attentionAnalyzer.analyzeFrame(lm);
          // æ”¶é›†è§†çº¿æ•°æ®ç”¨äºæ ¡å‡†
          var done=calibrationSystem.collectFrame(st.gaze_x, st.gaze_y);
          // åŒæ—¶ä¸º FacialModeling è®°å½•å¸§æ•°æ®ï¼ˆåªåœ¨ä¸­å¿ƒç‚¹é˜¶æ®µï¼‰
          if(calibrationSystem.step===0) facialModel.recordFrame(st);
          if(done){
            // æ ¡å‡†å®Œæˆï¼šå»ºç«‹ä¸ªæ€§åŒ–åŸºçº¿
            facialModel.computeBaseline();
            // ç”¨æ ¡å‡†æ•°æ®åˆå§‹åŒ– EMA åŸºçº¿
            scoringSystem.user_ear_baseline=facialModel.baseline_ear;
            scoringSystem.user_gaze_stability=facialModel.baseline_gaze;
            scoringSystem.user_head_stability=Math.abs(facialModel.baseline_head.yaw)+Math.abs(facialModel.baseline_head.pitch);
            updateBaselineUI();
            sdk.sessionStartTime=Date.now();
            document.getElementById('scoreOverlay').style.display='block';
            document.getElementById('statusOverlay').style.display='flex';
            sdk._emit('calibrationComplete',{results:calibrationSystem.results,baseline:facialModel});
            console.log('[AttentionMonitor] æ ¡å‡†å®Œæˆï¼Œè¿›å…¥ç›‘æµ‹æ¨¡å¼');
          }
          return; // æ ¡å‡†ä¸­ä¸åšè¯„åˆ†
        }

        // --- æ­£å¸¸ç›‘æµ‹æ¨¡å¼ ---
        if(sdk.showLandmarks){
          canvasCtx.save();canvasCtx.translate(ce.width,0);canvasCtx.scale(-1,1);
          drawConnectors(canvasCtx,lm,FACEMESH_TESSELATION,{color:'#30a0ff20',lineWidth:0.5});
          drawConnectors(canvasCtx,lm,FACEMESH_RIGHT_EYE,{color:'#36d399',lineWidth:1});
          drawConnectors(canvasCtx,lm,FACEMESH_LEFT_EYE,{color:'#36d399',lineWidth:1});
          drawConnectors(canvasCtx,lm,FACEMESH_RIGHT_IRIS,{color:'#ff6a6a',lineWidth:1});
          drawConnectors(canvasCtx,lm,FACEMESH_LEFT_IRIS,{color:'#ff6a6a',lineWidth:1});
          canvasCtx.restore();
        }
        var st=attentionAnalyzer.analyzeFrame(lm);var sc=scoringSystem.calculate(st);voiceReminder.check(sc,st.attention_label);updateUI(st,sc);
        // æ›´æ–°ä¾§æ  EMA åŸºçº¿æ˜¾ç¤ºï¼ˆæ¯ 60 å¸§åˆ·æ–°ä¸€æ¬¡ï¼‰
        if(totalFrames%60===0) updateBaselineUI();
      }else{var st=attentionAnalyzer.analyzeFrame(null);var sc=scoringSystem.calculate(st);updateUI(st,sc);}
      fpsCounter++;var now=performance.now();if(now-lastFpsTime>=1000){currentFps=fpsCounter;fpsCounter=0;lastFpsTime=now;document.getElementById('fpsTag').textContent=currentFps+' FPS';}
    });
    return faceMesh;
  }

  async function startCamera(){
    var videoEl=document.getElementById('webcam'),canvasEl=document.getElementById('overlay');
    var btn=document.getElementById('btnStart'),lb=document.getElementById('loadingBar'),lf=document.getElementById('loadingBarFill');
    btn.textContent='åŠ è½½æ¨¡å‹ä¸­...';btn.disabled=true;lb.classList.add('active');lf.style.width='30%';
    try{
      initFaceMesh();lf.style.width='60%';
      await faceMesh.initialize();lf.style.width='80%';
      camera=new Camera(videoEl,{onFrame:async function(){await faceMesh.send({image:videoEl});},width:640,height:480});
      await camera.start();lf.style.width='100%';
      sdk.running=true;
      canvasEl.width=videoEl.videoWidth||640;canvasEl.height=videoEl.videoHeight||480;
      document.getElementById('startScreen').classList.add('hidden');
      // å¯åŠ¨ 5 ç‚¹æ ¡å‡†ï¼ˆæ ¡å‡†å®Œæˆåè‡ªåŠ¨è¿›å…¥ç›‘æµ‹æ¨¡å¼ï¼‰
      calibrationSystem.start();
      sdk._emit('sessionStart',{timestamp:new Date().toISOString(),config:config});
      console.log('[AttentionMonitor] v2.2 å¯åŠ¨ â†’ è¿›å…¥æ ¡å‡†æ¨¡å¼');
    }catch(err){
      btn.textContent='å¯åŠ¨æ‘„åƒå¤´';btn.disabled=false;lb.classList.remove('active');
      alert('æ— æ³•å¯åŠ¨: '+err.message+'\n\nè¯·ç¡®ä¿:\n1. å…è®¸æ‘„åƒå¤´æƒé™\n2. ä½¿ç”¨ HTTPS æˆ– localhost\n3. ç½‘ç»œå¯è®¿é—® CDN');
      console.error('[AttentionMonitor]',err);
    }
  }

  // === æŠ¥å‘Šå¯¼å‡º ===
  function generateReport(){
    var dur=sdk.sessionStartTime?(Date.now()-sdk.sessionStartTime)/1000:0;
    var avg=0;if(scoreHistory.length>0){var s=0;for(var i=0;i<scoreHistory.length;i++)s+=scoreHistory[i];avg=s/scoreHistory.length;}
    return{meta:{version:sdk.version,exportTime:new Date().toISOString(),sessionStart:sdk.sessionStartTime?new Date(sdk.sessionStartTime).toISOString():null,sessionDurationSec:Math.round(dur)},
      summary:{averageScore:Math.round(avg*10)/10,focusRate:totalFrames>0?Math.round(focusedFrames/totalFrames*1000)/10:0,longestFocusSec:Math.round(scoringSystem.longest_focus_duration*10)/10,totalInterruptions:scoringSystem.focus_interruptions,totalBlinks:attentionAnalyzer.blinks,adhdEvents:scoringSystem.adhd_features.total_events,inattentionCount:scoringSystem.adhd_features.inattention_count,hyperactivityCount:scoringSystem.adhd_features.hyperactivity_count,voiceReminders:voiceReminder.reminderCount},
      config:config,timeline:sessionTimeline};
  }

  // === åŸºçº¿ UI æ›´æ–° ===
  function updateBaselineUI() {
    var cal = calibrationSystem.isCalibrated();
    var badge = document.getElementById('calibBadge');
    badge.textContent = cal ? 'å·²æ ¡å‡†' : 'æœªæ ¡å‡†';
    badge.className = 'baseline-badge ' + (cal ? 'calibrated' : 'default');

    var fm = facialModel;
    document.getElementById('m-bl-ear').textContent = scoringSystem.user_ear_baseline.toFixed(3) + (cal ? '' : ' (é»˜è®¤)');
    document.getElementById('m-bl-gaze').textContent = '(' + calibrationSystem.reference_gaze_center[0].toFixed(2) + ', ' + calibrationSystem.reference_gaze_center[1].toFixed(2) + ')';
    document.getElementById('m-bl-tol').textContent = calibrationSystem.gaze_tolerance.toFixed(3) + (cal ? ' (ä¸ªæ€§åŒ–)' : ' (é»˜è®¤)');
    document.getElementById('m-bl-head').textContent = '(' + scoringSystem.user_head_stability.toFixed(1) + 'Â°)';
    document.getElementById('m-bl-ema').textContent = 'EAR=' + scoringSystem.user_ear_baseline.toFixed(3) + ' Î±=0.01';
  }

  // === å…¬å…± API ===
  sdk.toggleVoice=function(){sdk.voiceEnabled=!sdk.voiceEnabled;document.getElementById('btnVoice').classList.toggle('active',sdk.voiceEnabled);};
  sdk.toggleLandmarks=function(){sdk.showLandmarks=!sdk.showLandmarks;document.getElementById('btnLandmarks').classList.toggle('active',sdk.showLandmarks);};
  sdk.resetStats=function(){scoringSystem.reset();attentionAnalyzer.reset();voiceReminder.reset();scoreHistory.length=0;sessionTimeline.length=0;totalFrames=0;focusedFrames=0;updateStatsUI();};
  sdk.skipCalibration=function(){
    calibrationSystem.skip();
    sdk.sessionStartTime=Date.now();
    document.getElementById('scoreOverlay').style.display='block';
    document.getElementById('statusOverlay').style.display='flex';
    updateBaselineUI();
    console.log('[AttentionMonitor] è·³è¿‡æ ¡å‡†ï¼Œä½¿ç”¨é»˜è®¤é˜ˆå€¼');
  };
  sdk.recalibrate=function(){
    if(!sdk.running)return;
    facialModel.reset();
    document.getElementById('scoreOverlay').style.display='none';
    document.getElementById('statusOverlay').style.display='none';
    calibrationSystem.start();
  };
  sdk.exportReport=function(){var j=JSON.stringify(generateReport(),null,2);var b=new Blob([j],{type:'application/json'});var u=URL.createObjectURL(b);var a=document.createElement('a');a.href=u;a.download='attention-report-'+new Date().toISOString().slice(0,19).replace(/:/g,'-')+'.json';a.click();URL.revokeObjectURL(u);};
  sdk.getReport=generateReport;
  sdk.getConfig=function(){return config;};
  sdk.setConfig=function(nc){for(var k in nc){if(config.hasOwnProperty(k))config[k]=nc[k];}};
  sdk.getCurrentScore=function(){return scoringSystem.score_history.length?scoringSystem.score_history[scoringSystem.score_history.length-1]:null;};
  sdk.getCurrentState=function(){return attentionAnalyzer.current_state;};

  document.addEventListener('DOMContentLoaded',function(){document.getElementById('btnStart').addEventListener('click',startCamera);});
  return sdk;
})();
</script>
</body>
</html>
